# ToolMsgForwarder 微信消息转发插件

ToolMsgForwarder 是一个功能强大的微信消息转发插件，可以根据配置规则将特定来源的消息（文本、图片、文件、视频）转发到指定的目标。

## 重要说明

**注意：本插件不会自动创建默认配置。必须手动创建正确的配置文件，否则插件将被禁用。**

**从 v1.0.0 版本开始，插件只支持统一规则配置，不再支持按消息类型分别配置规则。**

## 主要功能

- 支持转发文本、图片、文件和视频消息
- 可以监听特定群聊或私聊消息
- 可以只监听群内特定成员的消息
- 可以转发到多个目标
- 支持为群聊、发送者和接收者配置友好的别名
- 可以在转发的消息前添加来源信息
- **内置商品链接转链功能，支持淘宝、京东等平台**
- **支持通用规则配置，一个规则可以处理多种消息类型**
- **支持规则级别的转链控制，可以为每条规则单独设置是否启用转链**

## 配置方法

1. 在 `plugins/ToolMsgForwarder/` 目录下创建 `config.toml` 文件
2. 按照以下格式配置规则

### 配置文件格式

```toml
[ToolMsgForwarder]
# 全局设置
enable = true     # 总开关，设为false将完全禁用插件所有转发功能
priority = 99     # 插件优先级，值越小优先级越高

# ================ 转链功能配置 ================
[ToolMsgForwarder.rebate]
enable = true     # 是否启用转链功能
prepend_converted_tag = true  # 是否在转链消息中添加[已转链]标签
appkey = "你的折淘客APPKEY"  # 折淘客的对接秘钥appkey
sid = "你的SID"    # 折淘客的sid参数
union_id = "你的京东联盟ID"  # 京东联盟ID
pid = "mm_xxx_xxx_xxx"  # 淘宝联盟pid，格式为mm_xxx_xxx_xxx

# ==================== 统一规则配置 ====================
# 一个规则可以同时处理多种类型的消息
[[ToolMsgForwarder.rules]]
enabled = true                              # 此规则的开关
name = "测试群"                             # 群聊的易读名称，会在转发消息前缀中显示
from_wxid = "50144964587@chatroom"          # 来源群聊ID
listen_specific_senders_in_group = ["wxid_l4u1u9bgq5u022"]  # 监听的群成员
sender_names = { "wxid_l4u1u9bgq5u022" = "张三" }  # 发送者别名映射，会在转发消息前缀中显示
to_wxids = ["wxid_l4u1u9bgq5u022"]          # 转发目标wxid
target_names = { "wxid_l4u1u9bgq5u022" = "接收者" }  # 接收者别名（仅用于日志显示）
prepend_info = true                         # 是否在转发内容前添加来源信息
msg_types = ["text", "image", "file", "video"]  # 处理的消息类型
enable_rebate = true                        # 是否启用转链功能（仅对文本消息有效）
```

### 配置说明

#### 统一规则配置

| 字段 | 说明 |
|------|------|
| enabled | 是否启用此规则 |
| name | 来源（群聊或用户）的易读名称，会在转发消息前缀中显示 |
| from_wxid | 来源ID（群聊以@chatroom结尾） |
| listen_specific_senders_in_group | 只监听群内特定成员的消息（仅当来源是群聊时有效） |
| sender_names | 发送者别名映射，格式为 `{ "wxid" = "别名" }` |
| to_wxids | 转发目标ID数组 |
| target_names | 接收者别名映射，仅用于日志显示 |
| prepend_info | 是否在转发内容前添加来源信息 |
| msg_types | 处理的消息类型数组，可选值：text, image, file, video |
| enable_rebate | 是否启用转链功能（仅对文本消息有效） |

## 转发消息格式

转发的消息格式如下：

- 群消息：`[转发自群聊 群名称 (由 发送者名称 发送)]:`
- 私聊消息：`[转发自 联系人名称]:`

## 转链功能说明

插件内置了商品链接转链功能，可以自动将淘宝、京东等平台的商品链接转换为您的推广链接，支持以下格式：

- 淘口令（例如：￥1234abcd￥）
- 淘宝短链接（例如：https://m.tb.cn/xxx）
- 京东短链接（例如：https://u.jd.com/xxx）
- 其他各种格式的商品链接

要使用此功能，您需要在配置文件中设置您的推广ID和API密钥，如上述配置示例中的 `[ToolMsgForwarder.rebate]` 部分。

### 规则级别转链控制

您可以为每条规则单独设置是否启用转链功能。这在某些场景下非常有用，例如：

- 某些群聊中您希望保持原始链接而不进行转链
- 某些重要通知消息不希望修改其内容
- 只对特定来源的消息进行转链

要控制规则级别的转链，只需在规则配置中添加 `enable_rebate = true/false` 选项即可。

## 多消息类型支持

每条规则可以同时处理多种类型的消息。这样可以大大简化配置，避免为不同消息类型重复配置相同的规则。

使用 `msg_types` 字段指定要处理的消息类型，可以是 text、image、file、video 中的一个或多个。

## 注意事项

1. 必须手动创建配置文件，插件不会自动创建默认配置
2. wxid 必须准确，否则消息将无法正确转发
3. 至少需要配置一条有效的规则，否则插件将被禁用
4. 如果配置文件有语法错误，插件将被禁用
5. 修改配置后需要重启机器人才能生效
6. 尽量保证消息处理的高效，避免阻塞其他消息的处理

## 故障排除

- 如果插件无法正常工作，请检查日志中的错误信息
- 确保配置文件的格式正确，符合TOML语法规范
- 确保wxid正确且有效
- 检查是否有规则被成功启用

## 版本历史

- 1.0.0: 移除传统规则方式，仅支持统一规则配置
- 0.9.0: 移除兼容旧版配置的代码和废弃方法，简化插件结构
- 0.8.0: 移除钩子系统，简化代码，移动转链配置到顶层
- 0.7.0: 支持规则级别转链控制和多类型消息统一规则
- 0.6.0: 整合SecondProcessor的转链功能到主程序
- 0.5.0: 添加消息处理钩子系统，支持消息的二次处理
- 0.4.0: 移除默认配置创建功能，需要手动配置才能使用
- 0.3.6: 支持在配置中设置名称别名，优先显示别名而不是wxid
- 0.3.0: 支持表格数组配置格式
- 0.2.5: 完善配置加载，增强错误处理
- 0.2.4: 简化代码结构
- 0.2.0: 添加多目标转发和群内成员过滤功能
- 0.1.0: 初始版本 